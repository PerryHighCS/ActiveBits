# Repo Discoveries

Durable implementation notes and discoveries for future contributors and agents.

## How To Use

1. Append new entries; do not rewrite history.
2. Keep entries concise and evidence-backed.
3. Link to paths/commands/tests that support each claim.

## Entry Template

| Date | Area | Discovery | Why It Matters | Evidence | Follow-up | Owner |
|---|---|---|---|---|---|---|
| YYYY-MM-DD | client/server/activities/tooling/docs | <what was learned> | <impact/risk/value> | <file path, command, or test> | <next action> | <name> |

## Entries

| Date | Area | Discovery | Why It Matters | Evidence | Follow-up | Owner |
|---|---|---|---|---|---|---|
| 2026-02-07 | tooling/docs | `.gitignore` had `.claude/*` ignored with only `plans` re-included; knowledge files would have been dropped from git without explicit unignore rules. | Prevents loss of durable repo knowledge and agent context. | `.gitignore` entries `!.claude/knowledge/` and `!.claude/knowledge/**` | Keep new durable `.claude/*` folders explicitly unignored when introduced. | codex |
| 2026-02-07 | docs/process | `AGENTS.md` is the long-lived operational contract; TypeScript migration docs are now treated as historical context. | Separates permanent agent workflow from temporary migration planning artifacts. | `AGENTS.md` sections `Read First`, `Historical Discoveries`, `Evidence and Tracking` | Keep `AGENTS.md` current as workflows evolve; archive one-off plans under `.claude/plans/`. | codex |
| 2026-02-07 | server/build | Backend migration policy is compile TypeScript to `server/dist` and run Node on emitted JS; backend bundler is not required. | Avoids bundler complexity with dynamic activity loading and keeps runtime Node-native. | `.claude/plans/typescript.md` Phase 3 runtime policy, `server/tsconfig.build.json` plan block | Re-evaluate bundling only for concrete deploy constraints (single-file artifact/serverless). | codex |
| 2026-02-07 | client/server/deploy | Production source maps are intentionally public for this open-source repo (`client` and `server`). | Improves debugging and contributor transparency; must be reflected in deployment docs. | `.claude/plans/typescript.md` source map policy sections, `DEPLOYMENT.md` “Source Map Policy (Open-Source Repo)” | Verify `.map` artifacts in build/deploy checks (`client/dist`, `server/dist`). | codex |
| 2026-02-07 | activities/process | Activity migration batching rule is one activity directory per PR. | Reduces blast radius and simplifies rollback/review during high-volume migrations. | `.claude/plans/typescript.md` section `5.3 Activity batching policy (one activity per PR)` | Enforce in review template/checklist for Phase 5 PRs. | codex |
| 2026-02-07 | server/tests/tooling | In Codex sandbox, server tests and `verify:server` can fail with `EPERM` on socket bind even when local runs pass. | Prevents misclassifying environment limitations as repo regressions; requires explicit manual verification note. | `npm --workspace server test`, `npm run verify:server`, error `listen EPERM ... 0.0.0.0:4010`; user-confirmed local pass. | Treat local/CI as canonical for server bind-dependent checks; record manual verification in review logs. | codex |
| 2026-02-07 | client/tooling | Client `tsc --noEmit` can fail on `vite.config.ts` when root and client use different Vite majors, due plugin type mismatches. | Helps avoid false-negative typecheck failures during migration; informs tooling harmonization priority. | `npm run typecheck --workspaces --if-present`, error on `client/vite.config.ts` plugin types between root `vite@7` and client `vite@6`. | Harmonize Vite versions or isolate config typing strategy before strict config typecheck enforcement. | codex |
| 2026-02-07 | client/tooling | Vite type mismatch issue resolved by aligning root/client to Vite `7.3.1` and compatible plugin versions. | Confirms single-version toolchain removes cross-package type identity errors in `vite.config.ts` typecheck. | User-reported `npm ls vite` alignment + passing `npm run typecheck --workspaces --if-present` and `npm --workspace client run build`. | Keep root/client Vite and plugin versions in lockstep to prevent regression. | codex |
| 2026-02-07 | client/linting | Flat-config ESLint emits warning for `/* eslint-env node */` comment in `client/vite.config.ts`; this becomes an error target in ESLint v10. | Avoids future CI breaks on ESLint major upgrade. | `npm --workspace client test` warning output referencing `/client/vite.config.ts` line 1. | Replace with flat-config-compatible globals declaration or remove comment and rely on config-scoped globals. | codex |
| 2026-02-07 | client/linting | Removed legacy `/* eslint-env node */` from `client/vite.config.ts`; client lint now runs clean under current flat config. | Closes the previously recorded ESLint v10 migration warning path. | `npm --workspace client test` after removal (no ESLintEnvWarning). | Keep globals declared in flat config (not file comments) for future config files. | codex |
| 2026-02-07 | client/server/activities/migration | Mixed-extension activity loading now supports config and entry overlap windows (`activity.config.{js,ts}`, client `index.{js,jsx,ts,tsx}`, server `serverEntry` `.js`/`.ts` fallback). | Prevents loader/registry regressions while activities migrate one-by-one from JS to TS. | `client/src/activities/index.js`, `server/activities/activityRegistry.js`, `node --import tsx --test server/activities/activityRegistry.test.js` pass. | Keep extension-priority behavior stable (`.ts`/`.tsx` preferred) until final JS cleanup phase. | codex |
| 2026-02-07 | server/tests | `activityRegistry` compatibility tests can emit expected route-registration errors while still passing, because they intentionally use minimal `app/ws` stubs and intentionally broken temp configs in specific cases. | Prevents false-positive debugging churn when contributors see `TypeError`/`[ERROR]` lines in otherwise passing test runs. | User-local `npm --workspace server test` output: `35` pass, `0` fail, with expected logs from `registerActivityRoutes` and broken-config tests. | Consider tightening stubs in future to reduce log noise if it becomes a CI readability issue. | codex |
| 2026-02-07 | server/migration | During early Phase 3, converting core modules to `.ts` without keeping JS runtime compatibility breaks `verify:server` while `server/server.js` is still the plain-Node fallback entrypoint. | Prevents premature runtime regressions; backend module renames need either a TS entrypoint/runtime switch or temporary JS compatibility files until that switch lands. | `npm run verify:server` failure `Cannot find module .../server/core/sessionNormalization.js`, then pass after restoring JS compatibility files and running `npm run verify:server` outside sandbox. | In the next Phase 3 slice, migrate `server/server.js` to `server.ts` and update runtime fallback strategy so JS compatibility duplicates can be removed safely. | codex |
| 2026-02-07 | server/tooling | In this NodeNext + strict TS setup, `ioredis` default import in `.ts` required an explicit constructor/client interface cast to keep the Redis constructor and client methods type-safe without disabling strict checks. | Prevents migration stalls caused by `Cannot use namespace 'Redis' as a type` / non-constructable default import errors during backend TS conversion. | `server/core/valkeyStore.ts` typed `RedisConstructor`/`RedisClient` shim; `npm --workspace server run typecheck` pass after patch. | Revisit and simplify typings if upstream `ioredis` ESM typings are adjusted or project module interop changes. | codex |
| 2026-02-07 | server/types | Cross-module session interfaces in TS need to be shared from a single source (`sessions.ts`) instead of re-declared per file, or strict mode treats same-named shapes as incompatible in function signatures. | Avoids opaque “Two different types with this name exist, but they are unrelated” failures during incremental backend conversion. | `server/core/persistentSessionWs.ts` initial typecheck failure against `createSession`; fixed by exporting `SessionRecord`/`SessionStore` from `server/core/sessions.ts` and importing those types. | Continue exporting canonical backend contracts from core modules as additional files migrate to TS. | codex |
| 2026-02-07 | server/migration | Phase 3 route/registry transitional conversion works by adding TS counterparts (`statusRoute.ts`, `persistentSessionRoutes.ts`, `activityRegistry.ts`) while retaining existing JS runtime files. | Enables strict type progress on backend internals without forcing immediate runtime entrypoint cutover. | `npm --workspace server run typecheck` pass; `node --import tsx --test server/phase3RoutesRegistryTs.test.ts`; `npm --workspace server test` pass (`38`/`0`). | Next Phase 3 slice: migrate `server/server.js` to `server.ts` and move runtime to compiled `dist/server.js` as default. | codex |
| 2026-02-07 | server/test-runtime | In server tests run with `tsx`, importing `.js` specifiers can execute colocated `.ts` counterparts when present. | Provides immediate behavioral coverage for migrated TS modules before production runtime switches to compiled TS output. | `npm --workspace server test` stack traces show `server/activities/activityRegistry.ts` invoked by `server/activities/activityRegistry.test.js`. | Keep this behavior in mind when interpreting test coverage and regressions during mixed-extension phases. | codex |
