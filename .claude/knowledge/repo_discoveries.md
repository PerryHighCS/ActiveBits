# Repo Discoveries

Durable implementation notes and discoveries for future contributors and agents.

## How To Use

1. Append new entries; do not rewrite history.
2. Keep entries concise and evidence-backed.
3. Link to paths/commands/tests that support each claim.

## Entry Template

| Date | Area | Discovery | Why It Matters | Evidence | Follow-up | Owner |
|---|---|---|---|---|---|---|
| YYYY-MM-DD | client/server/activities/tooling/docs | <what was learned> | <impact/risk/value> | <file path, command, or test> | <next action> | <name> |

## Entries

| Date | Area | Discovery | Why It Matters | Evidence | Follow-up | Owner |
|---|---|---|---|---|---|---|
| 2026-02-07 | tooling/docs | `.gitignore` had `.claude/*` ignored with only `plans` re-included; knowledge files would have been dropped from git without explicit unignore rules. | Prevents loss of durable repo knowledge and agent context. | `.gitignore` entries `!.claude/knowledge/` and `!.claude/knowledge/**` | Keep new durable `.claude/*` folders explicitly unignored when introduced. | codex |
| 2026-02-07 | docs/process | `AGENTS.md` is the long-lived operational contract; TypeScript migration docs are now treated as historical context. | Separates permanent agent workflow from temporary migration planning artifacts. | `AGENTS.md` sections `Read First`, `Historical Discoveries`, `Evidence and Tracking` | Keep `AGENTS.md` current as workflows evolve; archive one-off plans under `.claude/plans/`. | codex |
| 2026-02-07 | server/build | Backend migration policy is compile TypeScript to `server/dist` and run Node on emitted JS; backend bundler is not required. | Avoids bundler complexity with dynamic activity loading and keeps runtime Node-native. | `.claude/plans/typescript.md` Phase 3 runtime policy, `server/tsconfig.build.json` plan block | Re-evaluate bundling only for concrete deploy constraints (single-file artifact/serverless). | codex |
| 2026-02-07 | client/server/deploy | Production source maps are intentionally public for this open-source repo (`client` and `server`). | Improves debugging and contributor transparency; must be reflected in deployment docs. | `.claude/plans/typescript.md` source map policy sections, `DEPLOYMENT.md` “Source Map Policy (Open-Source Repo)” | Verify `.map` artifacts in build/deploy checks (`client/dist`, `server/dist`). | codex |
| 2026-02-07 | activities/process | Activity migration batching rule is one activity directory per PR. | Reduces blast radius and simplifies rollback/review during high-volume migrations. | `.claude/plans/typescript.md` section `5.3 Activity batching policy (one activity per PR)` | Enforce in review template/checklist for Phase 5 PRs. | codex |
| 2026-02-07 | server/tests/tooling | In Codex sandbox, server tests and `verify:server` can fail with `EPERM` on socket bind even when local runs pass. | Prevents misclassifying environment limitations as repo regressions; requires explicit manual verification note. | `npm --workspace server test`, `npm run verify:server`, error `listen EPERM ... 0.0.0.0:4010`; user-confirmed local pass. | Treat local/CI as canonical for server bind-dependent checks; record manual verification in review logs. | codex |
| 2026-02-07 | client/tooling | Client `tsc --noEmit` can fail on `vite.config.ts` when root and client use different Vite majors, due plugin type mismatches. | Helps avoid false-negative typecheck failures during migration; informs tooling harmonization priority. | `npm run typecheck --workspaces --if-present`, error on `client/vite.config.ts` plugin types between root `vite@7` and client `vite@6`. | Harmonize Vite versions or isolate config typing strategy before strict config typecheck enforcement. | codex |
| 2026-02-07 | client/tooling | Vite type mismatch issue resolved by aligning root/client to Vite `7.3.1` and compatible plugin versions. | Confirms single-version toolchain removes cross-package type identity errors in `vite.config.ts` typecheck. | User-reported `npm ls vite` alignment + passing `npm run typecheck --workspaces --if-present` and `npm --workspace client run build`. | Keep root/client Vite and plugin versions in lockstep to prevent regression. | codex |
| 2026-02-07 | client/linting | Flat-config ESLint emits warning for `/* eslint-env node */` comment in `client/vite.config.ts`; this becomes an error target in ESLint v10. | Avoids future CI breaks on ESLint major upgrade. | `npm --workspace client test` warning output referencing `/client/vite.config.ts` line 1. | Replace with flat-config-compatible globals declaration or remove comment and rely on config-scoped globals. | codex |
| 2026-02-07 | client/linting | Removed legacy `/* eslint-env node */` from `client/vite.config.ts`; client lint now runs clean under current flat config. | Closes the previously recorded ESLint v10 migration warning path. | `npm --workspace client test` after removal (no ESLintEnvWarning). | Keep globals declared in flat config (not file comments) for future config files. | codex |
| 2026-02-07 | client/server/activities/migration | Mixed-extension activity loading now supports config and entry overlap windows (`activity.config.{js,ts}`, client `index.{js,jsx,ts,tsx}`, server `serverEntry` `.js`/`.ts` fallback). | Prevents loader/registry regressions while activities migrate one-by-one from JS to TS. | `client/src/activities/index.js`, `server/activities/activityRegistry.js`, `node --import tsx --test server/activities/activityRegistry.test.js` pass. | Keep extension-priority behavior stable (`.ts`/`.tsx` preferred) until final JS cleanup phase. | codex |
| 2026-02-07 | server/tests | `activityRegistry` compatibility tests can emit expected route-registration errors while still passing, because they intentionally use minimal `app/ws` stubs and intentionally broken temp configs in specific cases. | Prevents false-positive debugging churn when contributors see `TypeError`/`[ERROR]` lines in otherwise passing test runs. | User-local `npm --workspace server test` output: `35` pass, `0` fail, with expected logs from `registerActivityRoutes` and broken-config tests. | Consider tightening stubs in future to reduce log noise if it becomes a CI readability issue. | codex |
| 2026-02-07 | server/migration | During early Phase 3, converting core modules to `.ts` without keeping JS runtime compatibility breaks `verify:server` while `server/server.js` is still the plain-Node fallback entrypoint. | Prevents premature runtime regressions; backend module renames need either a TS entrypoint/runtime switch or temporary JS compatibility files until that switch lands. | `npm run verify:server` failure `Cannot find module .../server/core/sessionNormalization.js`, then pass after restoring JS compatibility files and running `npm run verify:server` outside sandbox. | In the next Phase 3 slice, migrate `server/server.js` to `server.ts` and update runtime fallback strategy so JS compatibility duplicates can be removed safely. | codex |
| 2026-02-07 | server/tooling | In this NodeNext + strict TS setup, `ioredis` default import in `.ts` required an explicit constructor/client interface cast to keep the Redis constructor and client methods type-safe without disabling strict checks. | Prevents migration stalls caused by `Cannot use namespace 'Redis' as a type` / non-constructable default import errors during backend TS conversion. | `server/core/valkeyStore.ts` typed `RedisConstructor`/`RedisClient` shim; `npm --workspace server run typecheck` pass after patch. | Revisit and simplify typings if upstream `ioredis` ESM typings are adjusted or project module interop changes. | codex |
| 2026-02-07 | server/types | Cross-module session interfaces in TS need to be shared from a single source (`sessions.ts`) instead of re-declared per file, or strict mode treats same-named shapes as incompatible in function signatures. | Avoids opaque “Two different types with this name exist, but they are unrelated” failures during incremental backend conversion. | `server/core/persistentSessionWs.ts` initial typecheck failure against `createSession`; fixed by exporting `SessionRecord`/`SessionStore` from `server/core/sessions.ts` and importing those types. | Continue exporting canonical backend contracts from core modules as additional files migrate to TS. | codex |
| 2026-02-07 | server/migration | Phase 3 route/registry transitional conversion works by adding TS counterparts (`statusRoute.ts`, `persistentSessionRoutes.ts`, `activityRegistry.ts`) while retaining existing JS runtime files. | Enables strict type progress on backend internals without forcing immediate runtime entrypoint cutover. | `npm --workspace server run typecheck` pass; `node --import tsx --test server/phase3RoutesRegistryTs.test.ts`; `npm --workspace server test` pass (`38`/`0`). | Next Phase 3 slice: migrate `server/server.js` to `server.ts` and move runtime to compiled `dist/server.js` as default. | codex |
| 2026-02-07 | server/test-runtime | In server tests run with `tsx`, importing `.js` specifiers can execute colocated `.ts` counterparts when present. | Provides immediate behavioral coverage for migrated TS modules before production runtime switches to compiled TS output. | `npm --workspace server test` stack traces show `server/activities/activityRegistry.ts` invoked by `server/activities/activityRegistry.test.js`. | Keep this behavior in mind when interpreting test coverage and regressions during mixed-extension phases. | codex |
| 2026-02-07 | server/entrypoint | Adding `server/server.ts` enables `tsc -p server/tsconfig.build.json` to emit `server/dist/server.js`, while the `start` script can still safely fall back to `server.js` when dist is absent. | Moves Phase 3 closer to compiled runtime default without breaking existing fallback-based workflows. | `server/server.ts`; `npm --workspace server run typecheck`; `npm --workspace server test`; `npm run verify:server`; `DEPLOYMENT.md` transitional runtime section updated. | In next cleanup slice, remove JS fallback entrypoint once `scripts/verify-server.js` and deployment flow are fully dist-first. | codex |
| 2026-02-07 | server/scripts | Valkey utility scripts can be migrated incrementally by adding `.ts` counterparts and making npm scripts prefer TS with JS fallback. | Keeps operational tooling usable during migration while advancing strict typing coverage. | `server/test-valkey.ts`, `server/monitor-valkey.ts`, `server/package.json` script updates, `npm test` pass. | Remove JS script fallbacks after remaining backend test/script migration work is complete. | codex |
| 2026-02-07 | server/tests | Backend test migration can proceed file-by-file by renaming individual `*.test.js` files to `*.test.ts` without changing discovery command semantics. | Reduces migration risk and keeps regression signal clear while preserving full-suite coverage. | `server/broadcastUtils.test.ts` replacing `server/broadcastUtils.test.js`; `npm --workspace server test` pass (`38`/`0`). | Continue converting remaining server tests (`statusRoute`, `sessionStore`, `galleryWalkRoutes`, `persistentSessionRoutes`, `activityRegistry`) in small slices. | codex |
| 2026-02-07 | server/tests | Phase 3 backend test migration is now complete: server test suite runs entirely from `.test.ts` files with strict typing fixes for `fetch().json()` and dynamic import helpers. | Closes the remaining backend JS test surface and reduces risk before Phase 4 frontend migration. | `rg --files server -g "*.test.js"` (no results), new TS files under `server/`, `npm --workspace server run typecheck`, `npm --workspace server test`, `npm test` all pass. | In cleanup phase, simplify server test discovery command to TS-only patterns after final JS removal policy is enacted. | codex |
| 2026-02-07 | server/runtime | After backend TS entrypoint and tests stabilized, legacy backend `.js` source fallbacks were safely removable; start/verify flows now run compiled `dist/server.js` or TS fallback (`node --import tsx server.ts`). | Eliminates duplicate backend code paths and drift risk while preserving local/runbook usability without requiring a prebuilt `dist` directory. | `server/package.json` start/dev/script updates, `scripts/verify-server.js` fallback logic, deletion of `server/server.js` and migrated `server/core|routes|activities/*.js` files, `npm test` pass. | During Phase 7, tighten test discovery to TS-only patterns and revisit whether TS runtime fallback should remain or become compile-required for all starts. | codex |
| 2026-02-07 | client/tests | Client workspace TS config currently sets `types` to `vite/client`, so Node runner tests converted to `.ts` need explicit Node type strategy; keeping new utility test as `.js` avoided introducing unrelated config churn in Phase 4 kickoff. | Prevents frontend migration stalls from `node:test` typing errors and keeps slice scope focused on utility conversion. | `client/tsconfig.json` (`types: ["vite/client"]`), `client/src/utils/csvUtils.ts` conversion with `client/src/utils/csvUtils.test.js`, `npm --workspace client test` pass. | Decide Phase 4 test-typing approach (per-file `/// <reference types="node" />` vs. dedicated test tsconfig) before bulk `.test.ts` migration. | codex |
| 2026-02-07 | server/types | `server/core/wsRouter.ts` had duplicate websocket interfaces that could drift from shared contracts; importing from `types/websocket.ts` and extending canonical types with `WsConnectionHandler` + `wss.close()` keeps server shutdown/router typing aligned. | Reduces maintenance risk from parallel interface edits and makes websocket contract changes propagate from one source. | `server/core/wsRouter.ts` type-only import from `../../types/websocket.js`, `types/websocket.ts` updates, `npm --workspace server run typecheck`, `npm --workspace server test`. | Reuse `types/websocket.ts` in additional websocket-related modules when practical to further reduce local ad-hoc interface copies. | codex |
| 2026-02-07 | server/types | `app.locals.sessions` no longer needs an unsafe `as unknown as never` cast after aligning shared session-store typing with the real server store contract. | Restores type-safety at bootstrap and reduces risk of silently hiding contract mismatches between Express locals and session store implementations. | `server/server.ts` direct assignment, `types/session.ts` contract updates, `server/core/sessions.ts` now extends shared `SessionStore`, `npm run typecheck --workspaces --if-present`, `npm --workspace server test`. | Keep shared `types/session.ts` and `server/core/sessions.ts` in lockstep when adding store features (pub/sub/cache hooks, method return types). | codex |
| 2026-02-07 | client/types | Migrating `client/src/activities/index.js` to TS required a canonical renderable component type because `React.lazy(...)` values are not plain `ComponentType`; `ActivityRegistryEntry` now models lazy-loaded components explicitly. | Prevents false type errors and contract drift in the activity registry while preserving lazy-loading behavior during mixed JS/TS migration. | `client/src/activities/index.ts`, `types/activity.ts`, `npm run typecheck --workspaces --if-present`, `npm test`. | Reuse `ActivityRenderableComponent` for future frontend component registries instead of re-declaring ad-hoc lazy/component unions. | codex |
| 2026-02-07 | client/hooks | Converting `useClipboard` to TS is straightforward when core clipboard/timer logic is extracted into a typed helper (`copyTextWithReset`) and tested directly under Node runner. | Keeps hook migration incremental without introducing new browser-test dependencies while still adding behavior-focused regression coverage. | `client/src/hooks/useClipboard.ts`, `client/src/hooks/useClipboard.test.ts`, `npm --workspace client test`, `npm test`. | Apply the same pattern to other hook migrations (`useSessionEndedHandler`, `useResilientWebSocket`) when direct React hook rendering tests are not yet available in client tooling. | codex |
| 2026-02-07 | client/hooks | `useSessionEndedHandler` TS migration stays low-risk when websocket message parsing is split into a pure helper (`isSessionEndedMessageData`) and hook logic keeps listener attach/cleanup unchanged. | Improves type safety for WebSocket event handling while keeping redirect behavior and cleanup semantics stable during incremental frontend migration. | `client/src/hooks/useSessionEndedHandler.ts`, `client/src/hooks/useSessionEndedHandler.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`. | Use the same “pure parser + typed hook shell” approach for `useResilientWebSocket` message/reconnect handling. | codex |
| 2026-02-07 | client/hooks | `useResilientWebSocket` migration is easier to verify by extracting small pure helpers (`resolveWebSocketUrl`, `getReconnectDelay`) and keeping connect/reconnect side effects in the hook shell. | Enables reliable Node-based tests for reconnect policy while preserving existing runtime websocket behavior in React components. | `client/src/hooks/useResilientWebSocket.ts`, `client/src/hooks/useResilientWebSocket.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`, `npm --workspace client run build`. | Continue this pattern for upcoming TSX component migrations: extract pure formatting/decision helpers where possible and test them directly. | codex |
| 2026-02-07 | client/ui | Migrating shared UI components to TSX is smoother when style/logic helpers are moved out of component files that are subject to `react-refresh/only-export-components`. | Keeps lint clean during TSX migration while retaining testable pure helper functions and stable component behavior. | `client/src/components/ui/Button.tsx`, `client/src/components/ui/buttonStyles.ts`, `client/src/components/ui/Modal.tsx`, `client/src/components/ui/RosterPill.tsx`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`, `npm --workspace client run build`. | Apply the same split pattern when migrating additional shared components that need exported utility functions. | codex |
| 2026-02-07 | client/common | For router-dependent components like `SessionEnded`, rendering under `MemoryRouter` provides lightweight regression coverage in Node tests without introducing browser test tooling. | Keeps migration momentum while validating key UI copy/structure around navigation-dependent hooks (`useNavigate`). | `client/src/components/common/SessionEnded.tsx`, `client/src/components/common/SessionEnded.test.tsx`, `client/src/components/common/LoadingFallback.tsx`, `client/src/components/common/LoadingFallback.test.tsx`, `npm --workspace client test`. | Reuse this pattern for additional route-aware component migrations until dedicated DOM test tooling is introduced. | codex |
| 2026-02-07 | client/common | Browser/hardware-bound UI (QR scanning) can still be migration-tested by extracting deterministic error-mapping utilities and validating those helpers directly in Node tests. | Preserves TypeScript migration velocity and regression coverage when components depend on camera/scanner hooks that are not practical in the current test runtime. | `client/src/components/common/QrScannerPanel.tsx`, `client/src/components/common/qrScannerUtils.ts`, `client/src/components/common/qrScannerUtils.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`. | Continue extracting pure parser/mapping helpers for remaining complex common components during TSX migration. | codex |
| 2026-02-07 | client/common | Route-aware manager headers that read `window.location` should guard for non-browser runtimes during migration, so static-render tests and SSR-like environments do not crash. | Allows safe TSX conversion and test coverage for navigation components without changing browser behavior. | `client/src/components/common/SessionHeader.tsx` (`typeof window !== 'undefined'` guard), `client/src/components/common/SessionHeader.test.tsx`, `npm --workspace client test`. | Apply the same runtime guard pattern where remaining components derive URLs from `window` directly. | codex |
| 2026-02-07 | client/common | For websocket-driven waiting-room UIs, strict TS is easier to maintain when inbound websocket payloads are parsed into a raw envelope and then narrowed with explicit message-shape guards before branching. | Prevents unsafe property access and keeps reconnect/auth navigation flows type-safe without changing runtime behavior. | `client/src/components/common/WaitingRoom.tsx`, `client/src/components/common/waitingRoomUtils.ts`, `client/src/components/common/waitingRoomUtils.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`. | Reuse raw-parse + type-guard message handling for remaining websocket-heavy components (e.g., `SessionRouter`) during TSX migration. | codex |
| 2026-02-07 | client/common | `StatusDashboard` TSX migration is safest when the API-shaping/formatting/sorting logic is extracted into pure typed helpers and tested separately from the polling UI shell. | Keeps strict typing aligned to `/api/status` while preserving behavior and adding deterministic coverage without browser-only test tooling. | `client/src/components/common/StatusDashboard.tsx`, `client/src/components/common/statusDashboardUtils.ts`, `client/src/components/common/statusDashboardUtils.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`. | Reuse the same "typed payload + extracted pure helpers" pattern for remaining large JSX components (`ManageDashboard`, `SessionRouter`). | codex |
| 2026-02-07 | client/common | `ManageDashboard` TSX migration is more stable when activity `deepLinkOptions` are normalized through typed helper functions rather than read directly from `unknown` config objects in JSX. | Avoids repeated ad-hoc casts during render paths and keeps persistent/solo link generation behavior testable under strict TypeScript. | `client/src/components/common/ManageDashboard.tsx`, `client/src/components/common/manageDashboardUtils.ts`, `client/src/components/common/manageDashboardUtils.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`. | Reuse `manageDashboardUtils` parsing/normalization helpers when `SessionRouter` migrates, since it also consumes activity config and deep-link query behavior. | codex |
| 2026-02-07 | client/common | `SessionRouter` TSX migration is easier to stabilize by isolating localStorage cache cleanup and persistent-query serialization into pure helpers before typing route-branch rendering logic. | Reduces type noise in a large multi-flow component and makes cache/query behavior regression-testable without rendering-heavy route tests. | `client/src/components/common/SessionRouter.tsx`, `client/src/components/common/sessionRouterUtils.ts`, `client/src/components/common/sessionRouterUtils.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`. | Reuse this extraction-first approach when converting `App.jsx` and `main.jsx` to keep route shell typing changes reviewable. | codex |
| 2026-02-07 | client/entrypoints | Converting `App`/`main` to TSX is low-risk when route/footer decision logic is extracted into a small pure helper and tested independently (`findFooterActivity`). | Keeps entrypoint migration reviewable while preserving dynamic activity route generation and lazy footer behavior. | `client/src/App.tsx`, `client/src/main.tsx`, `client/src/appUtils.ts`, `client/src/appUtils.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`. | Apply the same “extract + test pure routing helper” pattern if additional route-shell refactors are needed during Phase 4/5. | codex |
| 2026-02-07 | client/tests | After converting `index.test` and `csvUtils.test` to TS, `client/src` has no remaining `.js/.jsx` files; all client tests now run from `.test.ts/.test.tsx`. | Closes the remaining client JS test surface and removes a blocker for later `allowJs: false` cleanup in Phase 7. | `rg --files client/src -g '*.js' -g '*.jsx'` (no results), `client/src/activities/index.test.ts`, `client/src/utils/csvUtils.test.ts`, `npm --workspace client test`, `npm run typecheck --workspaces --if-present`. | In cleanup phase, simplify client test discovery command to TS-only patterns once cross-workspace JS test compatibility is no longer needed. | codex |
| 2026-02-07 | activities/tooling | TypeScript activity conversions that import shared client modules via `@src/*` require an `@src/*` path mapping in `activities/tsconfig.json`; otherwise activities typecheck fails even though runtime bundling works in client builds. | Prevents repeated TS migration friction when converting activity client code that already uses shared hooks/components from `client/src`. | `activities/tsconfig.json` paths update (`@src/*` -> `../client/src/*`), `npm run typecheck --workspaces --if-present` pass after change. | Keep `activities` TS path mappings aligned with client alias usage during Phase 5, and revisit alias cleanup rules in Phase 7. | codex |
| 2026-02-07 | activities/raffle | Full raffle activity migration to TS works as a single vertical slice when winner-selection logic is extracted into a pure helper (`raffleUtils.ts`) with deterministic tests. | Keeps one-activity-per-slice policy while adding concrete regression coverage for raffle draw rules and minimizing behavior drift during JSX/JS -> TSX/TS conversion. | `activities/raffle/*` TS files, `activities/raffle/client/manager/raffleUtils.test.ts`, `npm --workspace activities test`, `npm --workspace client run build`. | Apply the same extract-and-test approach for upcoming activity slices (`www-sim`, `java-string-practice`) where route/client files are larger. | codex |
| 2026-02-07 | activities/client-types | Activity client entry modules converted to TSX often need explicit `ComponentType<unknown>` casts for manager/student exports to satisfy the shared `ActivityClientModule` contract during mixed-prop migration. | Avoids false-negative type errors when activity student/manager components still use activity-specific prop contracts while the registry expects `unknown` props. | `activities/www-sim/client/index.tsx`, `activities/raffle/client/index.tsx`, `npm run typecheck --workspaces --if-present`. | As more activities migrate, replace cast-heavy exports by tightening shared activity component prop contracts where feasible. | codex |
